---
title: "ERA5 Month-End Data Download"
format: html
---

```{python}
import ee
import datetime
from dateutil.relativedelta import relativedelta
```

```{python}
ee.Initialize(project='ee-henryhwang2001')
print(f"Google Earth Engine Connected...")
```

```{python}
# Time range
START_DATE = '2019-01-01'
END_DATE = '2024-12-31'

## BC bounds
BC_bounds = ee.FeatureCollection('projects/ee-henryhwang2001/assets/BC_Boundary_simple')

## spatial resolution
scale = 25000 ## matching 0.25 degree

## Google Drive folder
Drive_Folder = 'BC_ERA5_MonthEnd_Data'
```

```{python}
import geemap
Map = geemap.Map()
Map.addLayer(BC_bounds, {}, "BC Boundary")
Map
```

```{python}
## Variables - 23 in total
VARIABLES = [
    # Temperature (5)
    'temperature_2m',                      # 2米平均气温 (K)
    'temperature_2m_max',                  # 2米最高气温 (K)
    'temperature_2m_min',                  # 2米最低气温 (K)
    'dewpoint_temperature_2m',             # 2米露点温度 (K)
    'skin_temperature',                    # 地表温度 (K)
    
    # precipitation (3)
    'total_precipitation_sum',             # 总降水量 (m)
    'surface_runoff_sum',                  # 地表径流 (m)
    
    # wind speed (2)
    'u_component_of_wind_10m',             # 10米风速U分量 (m/s)
    'v_component_of_wind_10m',             # 10米风速V分量 (m/s)
    
    # pressure (2)
    'surface_pressure',                    # 地表气压 (Pa)
    'total_evaporation_sum',               # 总蒸发量 (m)
    
    # radiation (2)
    'surface_solar_radiation_downwards_sum',    # 太阳辐射 (J/m²)
    'surface_thermal_radiation_downwards_sum',  # 热辐射 (J/m²)
    
    # soil temperature (4)
    'soil_temperature_level_1',            # 土壤温度 0-7cm (K)
    'soil_temperature_level_2',            # 土壤温度 7-28cm (K)
    'soil_temperature_level_3',            # 土壤温度 28-100cm (K)
    'soil_temperature_level_4',            # 土壤温度 100-289cm (K)
    
    # soil water (4)
    'volumetric_soil_water_layer_1',       # 土壤水分 0-7cm (m³/m³)
    'volumetric_soil_water_layer_2',       # 土壤水分 7-28cm (m³/m³)
    'volumetric_soil_water_layer_3',       # 土壤水分 28-100cm (m³/m³)
    'volumetric_soil_water_layer_4',       # 土壤水分 100-289cm (m³/m³)
    
    # snow (2)
    'snowfall_sum',                        # 降雪量 (m water equivalent)
    'snow_depth_water_equivalent'          # 积雪水当量 (m)
]

print(f"Extracting {len(VARIABLES)} Variables...")
```

```{python}
def generate_month_end_list(start_date, end_date):

    month_ends = []
    current = datetime.datetime.strptime(start_date, '%Y-%m-%d')
    end = datetime.datetime.strptime(end_date, '%Y-%m-%d')
    
    while current <= end:
        # last day in the month
        next_month = current + relativedelta(months=1)
        month_end = (next_month - datetime.timedelta(days=1))
        
        month_ends.append({
            'date': month_end.strftime('%Y-%m-%d'),
            'label': month_end.strftime('%Y_%m')
        })
        
        current = next_month
    
    return month_ends

month_ends = generate_month_end_list(START_DATE, END_DATE)
print(f"Exporting {len(month_ends)} month-end dates...")
print(f"First date: {month_ends[0]['date']}")
print(f"Last date: {month_ends[-1]['date']}")
```

```{python}
def export_month_end_era5(date_info, index):
    
    date = date_info['date']
    label = date_info['label']
    
    print(f"\n[{index+1}/{len(month_ends)}] 处理: {label} ({date})")
    
    # acquire single day data
    next_date = (datetime.datetime.strptime(date, '%Y-%m-%d') + 
                 datetime.timedelta(days=1)).strftime('%Y-%m-%d')
    
    # laod ERA5 data
    era5_image = ee.ImageCollection('ECMWF/ERA5_LAND/DAILY_AGGR') \
        .filterBounds(BC_bounds) \
        .filterDate(date, next_date) \
        .select(VARIABLES) \
        .first()
    
    # if data exists
    try:
        band_names = era5_image.bandNames().getInfo()
        print(f"  - Bands: {len(band_names)}")
    except:
        print(f"  No data found, skip")
        return None
    
    # configuration
    task_config = {
        'description': f'BC_ERA5_MonthEnd_{label}',
        'folder': Drive_Folder,
        'scale': scale,
        'region': BC_bounds.geometry().bounds().getInfo()['coordinates'],
        'maxPixels': 1e13,
        'fileFormat': 'GeoTIFF',
        'formatOptions': {
            'cloudOptimized': True
        }
    }
    
    # create task
    task = ee.batch.Export.image.toDrive(
        image=era5_image,
        **task_config
    )
    
    task.start()
    
    print(f"Submitted: {task_config['description']}")
    print(f"  - Task ID: {task.id}")
    
    return task
```

```{python}
def export_all_month_ends():
    
    print("\n" + "="*70)
    print("ERA5 Month-End Data...")
    print("="*70)
    
    tasks = []
    
    for i, date_info in enumerate(month_ends):
        task = export_month_end_era5(date_info, i)
        if task:
            tasks.append(task)
        
        if (i + 1) % 10 == 0:
            import time
            time.sleep(2)
    
    print("\n" + "="*70)
    print(f"Complete!")
    print("="*70)
    
    print("\nCheck Progress: https://code.earthengine.google.com/tasks")
    
    return tasks
```

```{python}
tasks = export_all_month_ends()
```

```{python}

```
